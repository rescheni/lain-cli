# ---------------------------------------------------------
# ğŸ§­ Lain-CLI è‡ªåŠ¨æ„å»ºä¸å‘å¸ƒå·¥ä½œæµ
# æ„å»º macOS & Linux å¹³å°çš„ amd64 / arm64 äºŒè¿›åˆ¶æ–‡ä»¶
# å¹¶åœ¨æ‰“ Tag æ—¶è‡ªåŠ¨åˆ›å»º Release ä¸Šä¼ äº§ç‰©
# ---------------------------------------------------------
name: Build Lain-CLI

# === è§¦å‘æ¡ä»¶ ===
on:
  push:                     # æ¯æ¬¡æ¨é€åˆ° main åˆ†æ”¯è§¦å‘æ„å»º
    branches: [ main ]
  pull_request:             # PR æäº¤åˆ° main æ—¶ä¹Ÿæ‰§è¡Œæ„å»ºéªŒè¯
    branches: [ main ]
  schedule:                 # æ¯å‘¨æ—¥ 0 ç‚¹è‡ªåŠ¨æ„å»ºï¼ˆå®šæ—¶æ„å»ºï¼‰
    - cron: '0 0 * * 0'
  workflow_dispatch:        # æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼ˆå¯åœ¨ GitHub Actions é¡µé¢ç‚¹å‡» Runï¼‰

# === æ„å»ºä»»åŠ¡å®šä¹‰ ===
jobs:
  build:
    name: Build binaries for macOS & Linux
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–° Ubuntu runner æ„å»ºç¯å¢ƒ

    strategy:
      matrix:
        goos: [darwin, linux]     # æ“ä½œç³»ç»Ÿç›®æ ‡
        goarch: [amd64, arm64]    # CPU æ¶æ„ç›®æ ‡
        # => æœ€ç»ˆä¼šæ„å»º 4 ä¸ªç‰ˆæœ¬ï¼š
        #    darwin-amd64, darwin-arm64, linux-amd64, linux-arm64

    steps:
      # 1ï¸âƒ£ æ‹‰å–é¡¹ç›®æºç 
      - name: Checkout code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ å®‰è£…æŒ‡å®š Go ç‰ˆæœ¬ï¼ˆè‡ªåŠ¨ç¼“å­˜ä¾èµ–ï¼‰
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'      # ä½ é¡¹ç›®ä½¿ç”¨çš„ Go ç‰ˆæœ¬ï¼Œå¯æŒ‰éœ€è°ƒæ•´

      # 3ï¸âƒ£ æ„å»ºé˜¶æ®µ
      - name: Build binary
        run: |
          mkdir -p dist
          BIN_NAME=lain-cli-${{ matrix.goos }}-${{ matrix.goarch }}
          echo "Building $BIN_NAME ..."
          # GOOS/GOARCH æŒ‡å®šç›®æ ‡ç³»ç»Ÿä¸æ¶æ„
          # -ldflags å‚æ•°å¯ç”¨äºå»é™¤è°ƒè¯•ä¿¡æ¯ (-s -w)
          # ä¹Ÿå¯æ³¨å…¥ç‰ˆæœ¬å·: "-s -w -X main.Version=${{ github.ref_name }}"
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} \
            go build -ldflags="-s -w" -o dist/$BIN_NAME
          ls -lh dist/

      # 4ï¸âƒ£ ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Actionsï¼ˆArtifactsï¼‰
      # æ„å»ºå®Œæˆåå¯åœ¨ "Actions â†’ Artifacts" ä¸‹è½½å¯¹åº”å¹³å°äºŒè¿›åˆ¶
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lain-cli-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/lain-cli-${{ matrix.goos }}-${{ matrix.goarch }}

  # === å‘å¸ƒä»»åŠ¡ ===
  # ä»…åœ¨æ‰“ Tagï¼ˆå¦‚ v0.1.0ï¼‰æ—¶è§¦å‘ï¼Œè‡ªåŠ¨åˆ›å»º Release
  release:
    name: Create GitHub Release
    needs: build                # ä¾èµ– build ä»»åŠ¡æ‰§è¡Œå®Œæˆ
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')   # ä»…åœ¨æ‰“ tag æ—¶è§¦å‘

    steps:
      # 1ï¸âƒ£ ä¸‹è½½ä¸Šä¸€æ­¥æ„å»ºçš„æ‰€æœ‰äºŒè¿›åˆ¶äº§ç‰©
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./dist          # æ‰€æœ‰äº§ç‰©ä¸‹è½½åˆ° dist ç›®å½•

      # 2ï¸âƒ£ åˆ›å»º Release å¹¶ä¸Šä¼ äº§ç‰©
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./dist/**      # ä¸Šä¼  dist ä¸‹æ‰€æœ‰æ–‡ä»¶
        env:
          # GitHub Actions è‡ªåŠ¨æ³¨å…¥çš„ token
          # æ— éœ€æ‰‹åŠ¨è®¾ç½®ï¼Œè‡ªåŠ¨æ‹¥æœ‰å‘å¸ƒæƒé™
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
